<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Shelly Plus power profiling</title>
  <style>
@import url('https://fonts.googleapis.com/css2?family=Bai+Jamjuree:wght@400&family=Nunito+Sans:wght@400&display=swap');

* { box-sizing: border-box; }
html, body {
  font-family: "Nunito Sans", Inter, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
  font-size: 16px;
  font-style: normal;
  font-weight: 400;
  line-height: 1.625rem;
  margin: 0;
  padding: 0;
  margin-left: auto;
  margin-right: auto;
  color: #042f2e;
  background-color: #ffffff;
}

@media (min-width: 576px) {
  body {
    max-width: 540px;
  }
}
@media (min-width: 768px) {
  body {
    max-width: 720px;
  }
}
@media (min-width: 992px) {
  body {
    max-width: 960px;
  }
}
@media (min-width: 1200px) {
  body {
    max-width: 1140px;
  }
}
@media (min-width: 1400px) {
  body {
    max-width: 1320px;
  }
}

h1 {
  font-family: "Bai Jamjuree", system-ui, sans-serif;
  font-size: 2.5rem;
  line-height: 3rem;
  font-weight: 400;
  letter-spacing: 0;
  margin-top: 0;
  margin-bottom: 1rem;
  color: #042f2e;
}

@media (min-width: 450px) {
  h1 {
    font-size: 3.25rem;
    line-height: 3.9rem;
  }
}

h1 span {
  color: #064e3b;
}

header {
  border-bottom: 1px solid rgba(0, 0, 0, 0.12);
  min-height: 72px;
  padding-block: 12px !important;
  padding: 12px 24px;
  align-items: center !important;
  display: flex !important;
  flex-wrap: wrap !important;
}

@media (min-width: 768px) {
  header {
    padding: 12px 72px;
  }
}

header > * {
  display: flex;
}

header > :first-child {
  margin-right: auto !important;
}

h3 {
  font-family: "Bai Jamjuree", system-ui, sans-serif;
  font-size: 1.46rem;
  line-height: 2.2rem;
  font-weight: 400;
  letter-spacing: 0;
  margin: 0;
  color: #042f2e;
}

h3 span {
  color: #064e3b;
  font-weight: 400;
}

.content {
  padding: 48px 24px;
}

@media (min-width: 768px) {
  .content {
    padding: 64px 72px;
  }
}

p {
  margin-top: 0;
  margin-bottom: 1rem;
}

code {
  background-color: #f3f4f6;
  padding: 0.2em 0.4em;
  border-radius: 4px;
  font-family: "Courier New", Courier, monospace;
  font-size: 0.9em;
}

input[type="text"] {
  border: 1px solid #064e3b88;
  border-radius: 4px;
  padding: 2px 4px;
  font-family: inherit;
  font-size: 0.9em;
}

.profile {
  color: #042f2e;
  border-radius: 0px;
  overflow: hidden;
  margin-bottom: 1em;
}
.profile > div {
  padding-top: 1px;
  border-left: 5px solid #064e3b88;
  border-right: 5px solid #064e3b88;
  border-top: 5px solid #064e3b88;
  position: relative;
  padding-bottom: calc(5% - 1px);
  border-top-left-radius: 8px;
  border-top-right-radius: 8px;
  overflow: hidden;
}
.profile > div > svg {
  position: absolute;
}
path {
  fill: #064e3b88;
  stroke: #042f2e;
  stroke-width: 6px;
  stroke-linejoin: bevel;
}
/* stroke-width = 3px * (viewBox width = 2400px) / min-width */
@media (min-width: 600px) {
  path {
    stroke-width: 12px;
  }
}
@media (min-width: 720px) {
  path {
    stroke-width: 10px;
  }
}
@media (min-width: 900px) {
  path {
    stroke-width: 8px;
  }
}
@media (min-width: 1020px) {
  path {
    stroke-width: 7px;
  }
}
@media (min-width: 1200px) {
  path {
    stroke-width: 6px;
  }
}
@media (min-width: 1440px) {
  path {
    stroke-width: 5px;
  }
}
@media (min-width: 1800px) {
  path {
    stroke-width: 4px;
  }
}
@media (min-width: 2400px) {
  path {
    stroke-width: 3px;
  }
}
@media (min-width: 3400px) {
  path {
    stroke-width: 2px;
  }
}
.profile > p {
  font-weight: bold;
  margin: 0;
  background-color: #064e3b88;
  color: #042f2e;
  border: 5px solid transparent;
  border-bottom-left-radius: 8px;
  border-bottom-right-radius: 8px;
  border-top: none;
}
.profile > p:before {
  border-top: 1px solid #e5e7eb;
  display: block;
  content: "";
}

.profile > table {
  margin-top: 0.5em;
  width: 100%;
  float: left;
  background-color: #064e3b88;
  border-radius: 8px;
  margin-right: 0.25em;
  table-layout: fixed;
}

.profile > table.power {
  margin-right: 0;
}

.profile > table.power td {
  text-align: center;
}

.profile > table a {
  color: #e5e7eb;
}

@media (min-width: 992px) {
  .profile > table {
    width: 50%;
    width: calc(50% - 0.25em);
  }
  .profile > table.power {
    margin-left: 0.25em;
  }
}

.profile > table td {
  padding: .1em .5em;
  background-color: #042f2e;
  color: #e5e7eb;
  min-width: 4em;
}

.profile > table th {
  padding: .1em .5em;
  background-color: transparent;
  color: #042f2e;
  font-weight: bold;
  text-align: center;
}


.profile > table tr:first-child td:first-child {
  border-top-left-radius: 6px;
}

.profile > table tr:first-child td:last-child {
  border-top-right-radius: 6px;
}

.profile > table tr:last-child td:first-child {
  border-bottom-left-radius: 6px;
}

.profile > table tr:last-child td:last-child {
  border-bottom-right-radius: 6px;
}

.profile > table.power tr:last-of-type > td:first-of-type {
  border-radius: 0px;
}

.profile > table.power tr:first-of-type > td:last-of-type {
  border-bottom-right-radius: 0px;
}

.profile > table.power tr:last-of-type > td:last-of-type {
  border-top-right-radius: 0px;
}

.profiler-link {
  background-position: center;
  background-repeat: no-repeat;
  background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" fill="%23042f2e" fill-opacity="context-fill-opacity"><path d="M8 0A8 8 0 0 0 .78 11.43a1 1 0 1 0 1.8-.86 5.94 5.94 0 0 1 0-5.17 6 6 0 0 1 10.83 5.17 1 1 0 1 0 1.81.86A7.99 7.99 0 0 0 8 0M10 12a2 2 0 1 1-4 0 2 2 0 0 1 4 0M10.96 6.7a.5.5 0 1 0-.92-.4l-1.7 3.73a2 2 0 0 1 .92.41l1.7-3.73z"/></svg>');
  float: right;
  width: 26px;
  height: 26px;
  padding: 5px;
}

.profiler-link:hover {
  background-color: #73737344;
}

a {
  color: #064e3b;
  text-decoration: underline;
}

a:hover {
  color: #042f2e;
  text-decoration: none;
}

footer {
  text-align: center;
  font-size: smaller;
  border-top: 1px solid rgba(0, 0, 0, 0.12);
  padding-top: 2rem !important;
  margin-top: 3rem;
  color: #374151;
}
footer img {
  height: 22px !important;
  width: auto;
  margin-left: 3px;
  vertical-align: text-bottom;
}
footer a {
  color: #374151;
}
  </style>
</head>
<body>
  <header>
    <div>
      <h3><span id="deviceNameH1">Shelly Plus</span> Power Profiling</h3>
    </div>
  </header>
  <div class="content">
    <h1 id="power">Live profile: <span id="lastPower">—</span> <span id="lastVoltage"></span></h1>
    <p>Shelly script URL: <code>http://<input type=text id="ip" value="192.168.1.89">/<input type="text" id="scriptPath" value="script/1/power"></code></p>
  <div class="profile">
    <div>
      <svg viewBox="0 0 2400 120">
        <path d=""/>
      </svg>
    </div>
    <p><span id="deviceNameProfile">Shelly Plus</span>, <span id="sampleCount">0</span> samples<a class="profiler-link" target="_blank" title="Open in the Firefox Profiler" id="open" href="#"></a></p>
    <table>
      <tr><th>Consumption</th><td><span id="totalEnergy">—</span></td></tr>
      <tr><th>Duration</th><td><span id="totalTime">—</span></td></tr>
      <tr><th rowspan="2">Download as</th><td><a id="csv" href="#">CSV</a></td></tr>
      <tr><td><a id="profile" href="#">profile</a></td></tr>
    </table>
    <table class="power">
      <tr><th rowspan="2">Power</th><td>median</td><td>average</td><td>max</td></tr>
      <tr>
        <td><span id="medianPower">—</span></td>
        <td><span id="averagePower">—</span></td>
        <td><span id="maxPower">—</span></td>
      </tr>
      <tr id="voltageHeaderRow"><th rowspan="2">Voltage</th><td>min</td><td>average</td><td>max</td></tr>
      <tr id="voltageRow">
        <td><span id="minVoltage">—</span></td>
        <td><span id="averageVoltage">—</span></td>
        <td><span id="maxVoltage">—</span></td>
      </tr>
    </table>
  </div>
  </div>
  <script type="application/javascript">
    let shellyPlusPowerData = [];
    let shellyPlusVoltageData = [];
    let shellyPlusFreqData = [];
    let shellyPlusPfData = [];
    let shellyPlusLastIndex = -1;
    let deviceName = "Shelly Plus";

    function setText(id, text) {
      document.getElementById(id).innerHTML = text;
    }

    function formatDuration(timeS) {
      let result = "";
      if (timeS >= 60) {
        let timeMin = Math.floor(timeS / 60);
        if (timeMin >= 60) {
          let timeHours = Math.floor(timeMin / 60);
          if (timeHours >= 24) {
            result = Math.floor(timeHours / 24) + "d";
            let hour = timeHours % 24;
            if (hour) {
              result += hour + "h";
            }
          } else {
            result = timeHours + "h";
            let min = timeMin % 60;
            if (min) {
              result += min + "min";
            }
          }
        } else {
          let sec = timeS % 60;
          result = timeMin + "min";
          if (sec) {
            result += sec + "s";
          }
        }
      } else {
        result = timeS + "s";
      }

      return result;
    }

    function toPrecisionIfNotInt(number) {
      // Because of floating point representations, we can get numbers like
      // 8.000000000000007. Treat them as if they were integers.
      let isAlmostInt = Math.round(number) == Math.round(number * 1000) / 1000;
      return isAlmostInt ? Math.round(number)
                         : number.toPrecision(3);
    }

    const nbsp = "&nbsp;";
    function formatPower(powerW) {
      if (powerW < 1 && powerW > 0) {
        return toPrecisionIfNotInt(powerW * 1000) + nbsp + "mW";
      }

      if (powerW > 1000) {
        return toPrecisionIfNotInt(powerW / 1000) + nbsp + "kW";
      }

      return toPrecisionIfNotInt(powerW) + nbsp + "W";
    }

    function formatEnergy(energyWh) {
      if (energyWh < 1 && energyWh > 0) {
        return toPrecisionIfNotInt(energyWh * 1000) + nbsp + "mWh";
      }

      if (energyWh > 1000) {
        return toPrecisionIfNotInt(energyWh / 1000) + nbsp + "kWh";
      }

      return toPrecisionIfNotInt(energyWh) + nbsp + "Wh";
    }

    function formatVoltage(voltageV) {
      return (Math.round(voltageV * 10) / 10) + nbsp + "V";
    }

    function setDeviceName(name) {
      deviceName = name;
      document.title = `${deviceName} power profiling`;
      setText("deviceNameProfile", deviceName);
      setText("deviceNameH1", deviceName);
    }

    async function getDeviceName() {
      let url = `ws://${document.getElementById("ip").value}/rpc`;

      let socket = new WebSocket(url);
      socket.onmessage = (event) => {
        let message = JSON.parse(event.data);
        if (message.id == 1) {
          setDeviceName("Shelly " + message.result.app);
          socket.close();
        }
      };
      socket.onopen = (event) => {
        socket.send('{"id":1,"method":"Shelly.GetDeviceInfo"}');
      }
    }

    async function fetchSamples() {
      let url = `http://${document.getElementById("ip").value}/${document.getElementById("scriptPath").value}`;
      if (shellyPlusLastIndex > 0) {
        url += "?" + (shellyPlusLastIndex);
      }
      let response = await fetch(url);
      let data = await response.json();

      if (shellyPlusLastIndex == -1) {
        shellyPlusPowerData = data.power_values.slice();
        if (data.voltage_values) {
          shellyPlusVoltageData = data.voltage_values.slice();
        } else {
          document.getElementById("voltageHeaderRow").remove();
          document.getElementById("voltageRow").remove();
        }
        if (data.freq_values) {
          shellyPlusFreqData = data.freq_values.slice();
          shellyPlusPfData = data.pf_values.slice();
        }
        shellyPlusLastIndex = data.start_index + shellyPlusPowerData.length;
      } else if (shellyPlusLastIndex < data.start_index + data.power_values.length) {
        let newPowerData = data.power_values.slice(shellyPlusLastIndex - data.start_index);
        shellyPlusPowerData = shellyPlusPowerData.concat(newPowerData);
        if (data.voltage_values) {
          let newVoltageData = data.voltage_values.slice(shellyPlusLastIndex - data.start_index);
          shellyPlusVoltageData = shellyPlusVoltageData.concat(newVoltageData);
        }
        if (data.freq_values) {
          let newFreqData = data.freq_values.slice(shellyPlusLastIndex - data.start_index);
          shellyPlusFreqData = shellyPlusFreqData.concat(newFreqData);
          let newPfData = data.pf_values.slice(shellyPlusLastIndex - data.start_index);
          shellyPlusPfData = shellyPlusPfData.concat(newPfData);
        }
        shellyPlusLastIndex += newPowerData.length;
      } else {
        console.log("unexpected", data);
      }
      setText("sampleCount", shellyPlusPowerData.length);
      setText("lastPower", formatPower(shellyPlusPowerData[shellyPlusPowerData.length - 1]));
      if (shellyPlusVoltageData.length) {
        setText("lastVoltage", formatVoltage(shellyPlusVoltageData[shellyPlusVoltageData.length - 1]));
      }
      showGraph();
    }

    const graphHeight = 120;
    const graphWidth = 2400;
    const halfStrokeWidth = 3;
    function makeSVGPath(graph) {
      let lastLetter = "";
      function letter(l) {
        if (l == lastLetter) {
          return "";
        }
        lastLetter = l;
        return l;
      }
      let path;
      function append(cmd) {
        if (/^\d/.test(cmd) && /\d$/.test(path)) {
          path += " ";
        }
        path += cmd;
      }
      let x = i => Math.round(graph[i].x * graphWidth);
      let y = i => graph[i].y == 0 ? graphHeight + halfStrokeWidth
          : Math.round(Math.max(halfStrokeWidth, (1 - graph[i].y) * graphHeight));
      let lastX = -halfStrokeWidth * 2;
      let lastY = y(0);
      path = `${letter('M')}${lastX} ${graphHeight}V${lastY}`;
      for (let i = 0; i < graph.length; ++i) {
        let xi = x(i);
        let yi = y(i);
        if (xi == lastX && yi == lastY) {
          continue;
        }
        if (yi == lastY) {
          while (i + 1 < graph.length && y(i + 1) == lastY) {
            xi = x(++i);
          }
          append(`${letter('h')}${xi - lastX}`);
        } else {
          if (xi == lastX) {
            let ys = [yi];
            let j = 1;
            while (i + j < graph.length && x(i + j) == xi) {
              ys.push(y(i + j));
              j++;
            }
            let usefulYs = [];
            let max = Math.max(...ys);
            let min = Math.min(...ys);
            let last = ys[ys.length - 1];
            if (max != last && max > lastY) {
              usefulYs.push(max);
            }
            if (min != last && min < lastY) {
              usefulYs.push(min);
            }
            usefulYs.push(last);

            i += j - 1;
            for (let usefulY of usefulYs) {
              yi = usefulY;
              let v = `${lastLetter != 'v' ? 'v' : ''}${yi - lastY}`;
              let V = `${lastLetter != 'V' ? 'V' : ''}${yi}`;
              if (v.length <= V.length) {
                append(v);
                lastLetter = 'v';
              } else {
                append(V);
                lastLetter = 'V';
              }
              lastY = yi;
            }
          } else {
            append(`${letter('l')}${xi - lastX}`);
            append(`${yi - lastY}`);
          }
        }
        lastX = xi;
        lastY = yi;
      }
      path += `H${graphWidth + halfStrokeWidth * 2}V${graphHeight}`;

      return path;
    }

    let graphOutdated = false;
    function showGraph() {
      if (document.hidden) {
        graphOutdated = true;
        return;
      }

      let maxPowerW = shellyPlusPowerData.reduce((a,b) => Math.max(a,b));
      let graph = shellyPlusPowerData.map((v, i) => ({
        x: i / (shellyPlusPowerData.length - 1),
        y: v / maxPowerW}));
      document.querySelector("path").setAttribute("d", makeSVGPath(graph));
      let energyWs = shellyPlusPowerData.reduce((acc, val) => acc + val);
      setText("maxPower", formatPower(maxPowerW));
      setText("totalTime", formatDuration(shellyPlusPowerData.length));
      setText("averagePower", formatPower(energyWs / shellyPlusPowerData.length));
      setText("medianPower", formatPower(shellyPlusPowerData.slice().sort((a, b) => a - b)[Math.floor(shellyPlusPowerData.length / 2)]));
      setText("totalEnergy", formatEnergy(energyWs / 3600));

      if (shellyPlusVoltageData.length) {
        setText("minVoltage", formatVoltage(shellyPlusVoltageData.reduce((a,b) => Math.min(a,b))));
        setText("averageVoltage", formatVoltage(shellyPlusVoltageData.reduce((a,b) => a + b) / shellyPlusVoltageData.length));
        setText("maxVoltage", formatVoltage(shellyPlusVoltageData.reduce((a,b) => Math.max(a,b))));
      }
    }

    setInterval(fetchSamples, 5000);
    getDeviceName();
    fetchSamples();

    function downloadCsv(event) {
      let mimeType = "text/plain";
      let data = shellyPlusPowerData.join("\n");
      let url = URL.createObjectURL(
        new Blob([data], { type: mimeType })
      );
      event.target.href = url;
      event.target.download = `${new Date().toDateString()} - ${document.getElementById("sampleCount").innerText} samples.csv`;
      setTimeout(() => URL.revokeObjectURL(url), 0);
    }

    function counterObject(name, description, times, samples) {
      let time = [];
      // Remove consecutive 0 samples.
      let count = samples.filter((sample, index) => {
	let keep =
          sample != 0 ||
          index == 0 || index == samples.length - 1 ||
          samples[index - 1] != 0 || samples[index + 1] != 0;
	if (keep) {
	  time.push(times[index])
	}
	return keep;
      });
      return {
        name,
        category: "power",
        description,
        pid: "0",
        mainThreadIndex: 0,
        samples: {
          time, count, length: count.length
        }
      }
    }
    function WattSecondToPicoWattHour(value) {
      return Math.round(value / 3600 * 1e12);
    }
    function makeProfile() {
      const baseProfile = '{"meta":{"interval":1000,"startTime":0,"abi":"","misc":"","oscpu":"","platform":"","processType":0,"extensions":{"id":[],"name":[],"baseURL":[],"length":0},"categories":[{"name":"Other","color":"grey","subcategories":["Other"]}],"product":"Home power profiling","stackwalk":0,"toolkit":"","version":27,"preprocessedProfileVersion":48,"appBuildID":"","sourceURL":"","physicalCPUs":1,"logicalCPUs":0,"CPUName":"Shelly Plus","symbolicationNotSupported":true,"markerSchema":[]},"libs":[],"pages":[],"threads":[{"processType":"default","processStartupTime":0,"processShutdownTime":null,"registerTime":0,"unregisterTime":null,"pausedRanges":[],"name":"GeckoMain","isMainThread":true,"pid":"0","tid":0,"samples":{"weightType":"samples","weight":null,"eventDelay":[],"stack":[],"time":[],"length":0},"markers":{"data":[],"name":[],"startTime":[],"endTime":[],"phase":[],"category":[],"length":0},"stackTable":{"frame":[0],"prefix":[null],"category":[0],"subcategory":[0],"length":1},"frameTable":{"address":[-1],"inlineDepth":[0],"category":[null],"subcategory":[0],"func":[0],"nativeSymbol":[null],"innerWindowID":[0],"implementation":[null],"line":[null],"column":[null],"length":1},"stringTable":{"_array":["(root)"],"_stringToIndex":{}},"funcTable":{"isJS":[false],"relevantForJS":[false],"name":[0],"resource":[-1],"fileName":[null],"lineNumber":[null],"columnNumber":[null],"length":1},"resourceTable":{"lib":[],"name":[],"host":[],"type":[],"length":0},"nativeSymbols":{"libIndex":[],"address":[],"name":[],"functionSize":[],"length":0}}],"counters":[]}';

      let profile = JSON.parse(baseProfile);
      let startTime = Date.now() - shellyPlusPowerData.length * 1000;
      profile.meta.startTime = startTime;
      profile.meta.profilingStartTime = 0;
      profile.meta.profilingEndTime = shellyPlusPowerData.length * 1000;
      profile.meta.CPUName = deviceName;

      profile.meta.markerSchema = [
        {
          name: "volt",
          tooltipLabel: "{marker.data.v}",
          display: [],
          data: [{key: "v", label: "Voltage", format: "string"}],
          graphs: [{key: "v", color: "orange", type: "line-filled"}],
        },
        {
          name: "pf",
          tooltipLabel: "{marker.data.pf}",
          display: [],
          data: [{key: "pf", label: "Power factor", format: "string"}],
          graphs: [{key: "pf", color: "blue", type: "line-filled"}],
        },
        {
          name: "f",
          tooltipLabel: "{marker.data.f}",
          display: [],
          data: [{key: "f", label: "Frequency (Hz)", format: "string"}],
          graphs: [{key: "f", color: "grey", type: "line-filled"}],
        }
      ];

      let times = shellyPlusPowerData.map((v, i) => i * 1000);
      let zeros = new Array(times.length).fill(0);

      let {samples, markers, stringTable} = profile.threads[0];
      samples.stack = zeros;
      samples.time = times;
      samples.length = times.length;

      profile.counters = [
        counterObject(deviceName,
                      `Data recorded by a ${deviceName} power meter`,
                      times, shellyPlusPowerData.map(WattSecondToPicoWattHour))
      ];

      let voltageIndex = stringTable._array.length;
      stringTable._array.push("Voltage");
      for (let i = 0; i < shellyPlusVoltageData.length; ++i) {
        markers.startTime.push(times[i]);
        markers.endTime.push(times[i]);
        // 0 = Instant marker, 1 = marker with start and end times, 2 = start but no end.
        markers.phase.push(1)
        markers.category.push(0);
        markers.name.push(voltageIndex)
        markers.data.push({type: "volt", v: shellyPlusVoltageData[i]});
      }

      let freqIndex = stringTable._array.length;
      stringTable._array.push("Frequency");
      for (let i = 0; i < shellyPlusFreqData.length; ++i) {
        markers.startTime.push(times[i]);
        markers.endTime.push(times[i]);
        // 0 = Instant marker, 1 = marker with start and end times, 2 = start but no end.
        markers.phase.push(1)
        markers.category.push(0);
        markers.name.push(freqIndex)
        markers.data.push({type: "f", f: shellyPlusFreqData[i]});
      }

      let pfIndex = stringTable._array.length;
      stringTable._array.push("Power Factor");
      for (let i = 0; i < shellyPlusPfData.length; ++i) {
        markers.startTime.push(times[i]);
        markers.endTime.push(times[i]);
        // 0 = Instant marker, 1 = marker with start and end times, 2 = start but no end.
        markers.phase.push(1)
        markers.category.push(0);
        markers.name.push(pfIndex)
        markers.data.push({type: "pf", pf: shellyPlusPfData[i]});
      }

      markers.length = markers.name.length;

      return profile;
    }

    function downloadProfile(event) {
      let mimeType = "application/json";
      let url = URL.createObjectURL(
        new Blob([JSON.stringify(makeProfile())], { type: mimeType })
      );
      event.target.href = url;
      event.target.download = `${new Date().toDateString()} - ${document.getElementById("sampleCount").innerText} samples.json`;
      setTimeout(() => URL.revokeObjectURL(url), 0);
    }

    async function openProfile() {
      const origin = "https://profiler.firefox.com";
      const profilerURL = origin + "/from-post-message/";
      const profilerWindow = window.open(profilerURL, "_blank");

      if (!profilerWindow) {
        console.error("Failed to open the new window.");
        return;
      }

      let isReady = false;
      window.addEventListener("message", function listener(event) {
        if (event.data && event.data.name === "ready:response") {
          window.removeEventListener("message", listener);
          isReady = true;
          const message = {
            name: "inject-profile",
            profile: makeProfile(),
          };
          profilerWindow.postMessage(message, origin);
        }
      });

      while (true) {
        await new Promise((resolve) => setTimeout(resolve, 100));
        if (isReady) {
          break;
        }
        profilerWindow.postMessage({ name: "ready:request" }, origin);
      }
    }

    document.getElementById("csv").addEventListener("click", downloadCsv);
    document.getElementById("profile").addEventListener("click", downloadProfile);
    document.getElementById("open").addEventListener("click", openProfile);
    document.addEventListener("visibilitychange", () => {
      if (!document.hidden && graphOutdated) {
        graphOutdated = false;
        showGraph();
      }
    });
  </script>
  <footer>This work © 2024 — 2025 by Florian Quèze is licensed under <a href="http://creativecommons.org/licenses/by-nc/4.0/" target="_blank" rel="license noopener noreferrer">CC BY-NC 4.0<img src="https://mirrors.creativecommons.org/presskit/icons/cc.svg" alt="CC"><img src="https://mirrors.creativecommons.org/presskit/icons/by.svg" alt="BY"><img src="https://mirrors.creativecommons.org/presskit/icons/nc.svg" alt="NC"></a></footer>
</body>
</html>
